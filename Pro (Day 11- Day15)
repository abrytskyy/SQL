----------Lesson 11----------



--OVER PARTITION BY



SELECT
*,
SUM(amount) OVER(PARTITION BY customer_id)
FROM payment

SELECT
*,
SUM(amount) OVER(PARTITION BY customer_id)
FROM payment
ORDER BY 1

SELECT
*,
COUNT(*) OVER(PARTITION BY customer_id)
FROM payment
ORDER BY 1

SELECT
*,
COUNT(*) OVER(PARTITION BY customer_id,staff_id)
FROM payment
ORDER BY 1

SELECT
*,
COUNT(*) OVER()
FROM payment
ORDER BY 1

SELECT
*,
ROUND(AVG(amount) OVER(),2)
FROM payment
ORDER BY 1

--Challenge 1
SELECT f.film_id, title, length as length_of_movie, name as category, 
ROUND(AVG(length) OVER(PARTITION BY name),2) FROM film f
LEFT JOIN film_category fc
ON f.film_id = fc.film_id
LEFT JOIN category c
ON c.category_id = fc.category_id
ORDER BY film_id

--Challenge 1(1)
SELECT 
f.film_id, 
title, 
name as category, 
length as length_of_movie,  
ROUND(AVG(length) OVER(PARTITION BY name),2) AS avg_length_in_category FROM film f
LEFT JOIN film_category fc
ON f.film_id = fc.film_id
LEFT JOIN category c
ON c.category_id = fc.category_id
ORDER BY 1

--Challenge 2
SELECT *,
COUNT(*) OVER(PARTITION BY customer_id, amount)AS no_payments_with_that_amount FROM payment
ORDER BY no_payments_with_that_amount

--Challenge 2(1)
SELECT *,
COUNT(*) OVER(PARTITION BY amount, customer_id)AS no_payments_with_that_amount FROM payment
ORDER BY customer_id



--OVER (ORDER BY)



SELECT *,
SUM(amount) OVER(ORDER BY payment_date)
FROM payment

SELECT *,
SUM(amount) OVER(ORDER BY payment_id)
FROM payment

SELECT *,
SUM(amount) OVER(PARTITION BY customer_id ORDER BY payment_id)
FROM payment

SELECT *,
SUM(amount) 
	OVER(PARTITION BY customer_id 
		 ORDER BY payment_date, payment_id)
FROM payment

--Challenge 3
SELECT flight_id, departure_airport,
SUM(actual_arrival-scheduled_arrival)OVER(ORDER BY flight_id)
FROM flights

--Challenge 4
SELECT 
flight_id, 
departure_airport,
SUM(actual_arrival-scheduled_arrival)
OVER(PARTITION BY departure_airport ORDER BY flight_id)
FROM flights



--RANK



SELECT 
f.title,
c.name,
f.length
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id

SELECT 
f.title,
c.name,
f.length,
RANK() OVER(ORDER BY length)
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id

SELECT 
f.title,
c.name,
f.length,
RANK() OVER(ORDER BY length DESC)
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id

SELECT 
f.title,
c.name,
f.length,
DENSE_RANK() OVER(ORDER BY length DESC)
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id

SELECT 
f.title,
c.name,
f.length,
DENSE_RANK() OVER(PARTITION BY name ORDER BY length DESC)
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id

--can not use where for window functions:
SELECT 
f.title,
c.name,
f.length,
DENSE_RANK() OVER(PARTITION BY name ORDER BY length DESC)
FROM film f
LEFT JOIN film_category fc ON f.film_id = fc.film_id
LEFT JOIN category c ON c.category_id = fc.category_id
WHERE (DENSE_RANK() OVER(PARTITION BY name ORDER BY length DESC)) = 1
--ERROR:  window functions are not allowed in WHERE
--LINE 9: WHERE (DENSE_RANK() OVER(PARTITION BY name ORDER BY length D...

SELECT * FROM 
(
	SELECT 
	f.title,
	c.name,
	f.length,
	DENSE_RANK() OVER(PARTITION BY name ORDER BY length DESC) as rank
	FROM film f
	LEFT JOIN film_category fc ON f.film_id = fc.film_id
	LEFT JOIN category c ON c.category_id = fc.category_id
) a
WHERE rank=1
               


